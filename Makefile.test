# Test automation Makefile for price-gh-bot
# Provides convenient commands for running different types of tests

.PHONY: test test-unit test-integration test-e2e test-all test-docker test-coverage
.PHONY: test-update-data test-verify lint format install-dev setup-pre-commit
.PHONY: clean-test clean-docker help

# Default target
help:
	@echo "ğŸ§ª Test Commands for price-gh-bot"
	@echo "=================================="
	@echo ""
	@echo "ğŸ“‹ Basic Test Commands:"
	@echo "  make test-unit         - Run fast unit tests"
	@echo "  make test-integration  - Run integration tests with mocks"
	@echo "  make test-e2e          - Run end-to-end tests with real URLs"
	@echo "  make test-all          - Run all tests in sequence"
	@echo "  make test-coverage     - Run tests with coverage report"
	@echo ""
	@echo "ğŸ³ Docker Test Commands:"
	@echo "  make test-docker       - Run all tests in Docker containers"
	@echo "  make test-docker-unit  - Run only unit tests in Docker"
	@echo "  make test-docker-dev   - Start development Docker environment"
	@echo ""
	@echo "ğŸ”§ Development Commands:"
	@echo "  make lint              - Run linting and formatting checks"
	@echo "  make format            - Auto-format code"
	@echo "  make install-dev       - Install development dependencies"
	@echo "  make setup-pre-commit  - Setup pre-commit hooks"
	@echo ""
	@echo "ğŸ“Š Data Management:"
	@echo "  make test-update-data  - Update test data from real sources"
	@echo "  make test-verify       - Verify test URLs are still accessible"
	@echo ""
	@echo "ğŸ§¹ Cleanup Commands:"
	@echo "  make clean-test        - Clean test artifacts"
	@echo "  make clean-docker      - Clean Docker test containers"
	@echo ""

# Environment setup
VENV_PATH = venv
PYTHON = $(VENV_PATH)/bin/python3
PIP = $(VENV_PATH)/bin/pip
PYTEST = $(VENV_PATH)/bin/pytest
TEST_ENV = BOT_TOKEN=8026508902:AAGWJKei_EyPkpc4x-lt-qFQo53829gQIrU ENABLE_HEADLESS_BROWSER=false

# Basic test commands
test: test-unit
	@echo "âœ… Quick tests completed"

test-unit:
	@echo "ğŸƒâ€â™‚ï¸ Running unit tests..."
	@$(TEST_ENV) $(PYTEST) tests_new/unit/ -v --tb=short --maxfail=5

test-integration:
	@echo "ğŸ”— Running integration tests..."
	@$(TEST_ENV) $(PYTEST) tests_new/integration/ -v --tb=short --maxfail=3

test-e2e:
	@echo "ğŸŒ Running end-to-end tests..."
	@BOT_TOKEN=8026508902:AAGWJKei_EyPkpc4x-lt-qFQo53829gQIrU ENABLE_HEADLESS_BROWSER=true $(PYTEST) tests_new/e2e/ -v --tb=short --maxfail=1 --timeout=120

test-all:
	@echo "ğŸš€ Running comprehensive test suite..."
	@$(MAKE) test-unit
	@$(MAKE) test-integration  
	@$(MAKE) test-e2e
	@echo "ğŸ‰ All tests completed successfully!"

test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	@$(TEST_ENV) $(PYTEST) tests_new/ -v --cov=app --cov-report=html --cov-report=term --cov-fail-under=70

# Docker test commands
test-docker:
	@echo "ğŸ³ Running all tests in Docker..."
	@docker-compose -f docker-compose.test.yml up test-all --build --abort-on-container-exit

test-docker-unit:
	@echo "ğŸ³ Running unit tests in Docker..."
	@docker-compose -f docker-compose.test.yml up test-unit --build --abort-on-container-exit

test-docker-integration:
	@echo "ğŸ³ Running integration tests in Docker..."
	@docker-compose -f docker-compose.test.yml up test-integration --build --abort-on-container-exit

test-docker-e2e:
	@echo "ğŸ³ Running E2E tests in Docker..."
	@docker-compose -f docker-compose.test.yml up test-e2e --build --abort-on-container-exit

test-docker-dev:
	@echo "ğŸ³ Starting development Docker environment..."
	@docker-compose -f docker-compose.test.yml up test-dev --build -d
	@echo "ğŸ“ Use: docker exec -it $$(docker-compose -f docker-compose.test.yml ps -q test-dev) bash"

test-docker-coverage:
	@echo "ğŸ³ Running coverage tests in Docker..."
	@docker-compose -f docker-compose.test.yml up test-coverage --build --abort-on-container-exit

# Development commands
lint:
	@echo "ğŸ” Running linting checks..."
	@$(VENV_PATH)/bin/ruff check app/ tests_new/
	@$(VENV_PATH)/bin/mypy app/
	@$(VENV_PATH)/bin/pydocstyle app/

format:
	@echo "âœ¨ Formatting code..."
	@$(VENV_PATH)/bin/ruff check app/ tests_new/ --fix
	@$(VENV_PATH)/bin/ruff format app/ tests_new/

install-dev:
	@echo "ğŸ“¦ Installing development dependencies..."
	@$(PIP) install -r requirements.txt -r requirements-dev.txt
	@$(VENV_PATH)/bin/playwright install chromium

setup-pre-commit:
	@echo "ğŸª Setting up pre-commit hooks..."
	@$(VENV_PATH)/bin/pre-commit install
	@$(VENV_PATH)/bin/pre-commit install --hook-type commit-msg

# Data management commands
test-update-data:
	@echo "ğŸ“Š Updating test data from real sources..."
	@$(TEST_ENV) $(PYTHON) tests_new/utils/data_updater.py

test-verify:
	@echo "ğŸ” Verifying test URLs are accessible..."
	@$(TEST_ENV) $(PYTHON) -c "
import asyncio
from tests_new.utils.data_updater import TestDataUpdater
async def main():
    updater = TestDataUpdater()
    await updater.verify_test_urls()
asyncio.run(main())
"

# Benchmark tests
test-benchmark:
	@echo "âš¡ Running performance benchmarks..."
	@$(TEST_ENV) $(PYTEST) tests_new/ -k "benchmark" --benchmark-json=benchmark.json

# Test with different Python versions (if available)
test-py311:
	@echo "ğŸ Testing with Python 3.11..."
	@python3.11 -m pytest tests_new/unit/ -v --tb=short

test-py312:
	@echo "ğŸ Testing with Python 3.12..."
	@python3.12 -m pytest tests_new/unit/ -v --tb=short

# CI simulation
test-ci:
	@echo "ğŸ­ Simulating CI pipeline..."
	@$(MAKE) lint
	@$(MAKE) test-unit
	@$(MAKE) test-integration
	@$(MAKE) test-docker-unit
	@echo "ğŸ¯ CI simulation completed"

# Cleanup commands
clean-test:
	@echo "ğŸ§¹ Cleaning test artifacts..."
	@rm -rf .pytest_cache
	@rm -rf htmlcov
	@rm -f .coverage
	@rm -f coverage.xml
	@rm -f benchmark.json
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true

clean-docker:
	@echo "ğŸ³ Cleaning Docker test containers..."
	@docker-compose -f docker-compose.test.yml down --volumes --remove-orphans
	@docker system prune -f

clean-all: clean-test clean-docker
	@echo "âœ¨ All test artifacts cleaned"

# Quick development cycle
dev-cycle:
	@echo "ğŸ”„ Running development cycle..."
	@$(MAKE) format
	@$(MAKE) test-unit
	@$(MAKE) lint
	@echo "âœ… Development cycle completed"

# Security tests
test-security:
	@echo "ğŸ”’ Running security tests..."
	@$(VENV_PATH)/bin/safety check
	@$(VENV_PATH)/bin/bandit -r app/ -f json -o bandit-report.json
	@echo "ğŸ“„ Security report: bandit-report.json"

# Documentation tests
test-docs:
	@echo "ğŸ“š Testing documentation..."
	@$(VENV_PATH)/bin/mkdocs build --strict
	@echo "âœ… Documentation builds successfully"

# Performance profiling
test-profile:
	@echo "âš¡ Profiling test performance..."
	@$(TEST_ENV) $(PYTEST) tests_new/unit/ --profile --profile-svg

# Test discovery
test-discover:
	@echo "ğŸ” Discovering tests..."
	@$(PYTEST) --collect-only tests_new/

# Verbose test run with all details
test-verbose:
	@echo "ğŸ”Š Running verbose tests..."
	@$(TEST_ENV) $(PYTEST) tests_new/ -v -s --tb=long

# Test specific file or pattern
test-file:
	@echo "ğŸ“„ Testing specific file: $(FILE)"
	@$(TEST_ENV) $(PYTEST) $(FILE) -v --tb=short

# Example: make test-file FILE=tests_new/unit/test_commission_contracts.py