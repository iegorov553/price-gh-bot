# Price Bot for Telegram

Telegram –±–æ—Ç –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å eBay –∏ Grailed —Å —É—á—ë—Ç–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏, –∫–æ–º–∏—Å—Å–∏–∏ –∏ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç. –í–∫–ª—é—á–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ Grailed.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º**: eBay –∏ Grailed (–≤–∫–ª—é—á–∞—è app.link —Å—Å—ã–ª–∫–∏)
- **–£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–π**: 
  - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è $15 –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–µ—à–µ–≤–ª–µ $150
  - –ù–∞—Ü–µ–Ω–∫–∞ 10% –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –æ—Ç $150
- **–†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –°–®–ê + –æ—Ü–µ–Ω–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –†–§ (Shopfans Lite)
- **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç**: –ü–µ—Ä–µ–≤–æ–¥ –≤ —Ä—É–±–ª–∏ –ø–æ –∫—É—Ä—Å—É –¶–ë –†–§ (+5% –Ω–∞—Ü–µ–Ω–∫–∞)
- **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ Grailed**: –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –ø–æ 4 –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ª–∏—Å—Ç–∏–Ω–≥–∞**: –†–∞–∑–ª–∏—á–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π –∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö URL –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- **–†–µ–∂–∏–º—ã —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è**: Webhook (–ø—Ä–æ–¥–∞–∫—à–Ω) –∏ polling (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

## –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ Grailed

–ë–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–∞ –ø–æ 4 –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ (–º–∞–∫—Å–∏–º—É–º 100 –±–∞–ª–ª–æ–≤)
- **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (0-30 –±–∞–ª–ª–æ–≤)**: –í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏—Å—Ç–∏–Ω–≥–æ–≤
  - 0-2 –¥–Ω—è: 30 –±–∞–ª–ª–æ–≤
  - 3-7 –¥–Ω–µ–π: 24 –±–∞–ª–ª–∞  
  - 8-30 –¥–Ω–µ–π: 12 –±–∞–ª–ª–æ–≤
  - >30 –¥–Ω–µ–π: –∫–∞—Ç–µ–≥–æ—Ä–∏—è "Ghost"
- **–†–µ–π—Ç–∏–Ω–≥ (0-35 –±–∞–ª–ª–æ–≤)**: –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞
  - 4.90-5.00: 35 –±–∞–ª–ª–æ–≤
  - 4.70-4.89: 30 –±–∞–ª–ª–æ–≤
  - 4.50-4.69: 24 –±–∞–ª–ª–∞
  - 4.00-4.49: 12 –±–∞–ª–ª–æ–≤
- **–û–±—ä—ë–º –æ—Ç–∑—ã–≤–æ–≤ (0-25 –±–∞–ª–ª–æ–≤)**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤
  - 200+: 25 –±–∞–ª–ª–æ–≤
  - 50-199: 20 –±–∞–ª–ª–æ–≤
  - 10-49: 15 –±–∞–ª–ª–æ–≤
  - 1-9: 5 –±–∞–ª–ª–æ–≤
- **–ë–µ–π–¥–∂ Trusted Seller (0-10 –±–∞–ª–ª–æ–≤)**: –ù–∞–ª–∏—á–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –±–µ–π–¥–∂–∞

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
- üíé **Diamond (85-100)**: –ü—Ä–æ–¥–∞–≤–µ—Ü —Ç–æ–ø-—É—Ä–æ–≤–Ω—è
- ü•á **Gold (70-84)**: –í—ã—Å–æ–∫–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
- ü•à **Silver (55-69)**: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
- ü•â **Bronze (40-54)**: –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫
- üëª **Ghost (<40 –∏–ª–∏ >30 –¥–Ω–µ–π)**: –ù–∏–∑–∫–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

## –õ–æ–≥–∏–∫–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∏—Å—Å–∏–π
- **–¢–æ–≤–∞—Ä—ã < $150**: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è $15
  - –ü—Ä–∏–º–µ—Ä: $89.99 + $12.50 –¥–æ—Å—Ç–∞–≤–∫–∞ = $102.49 ‚Üí **$117.49** (‚ÇΩ11,749)
- **–¢–æ–≤–∞—Ä—ã ‚â• $150**: –ù–∞—Ü–µ–Ω–∫–∞ 10%
  - –ü—Ä–∏–º–µ—Ä: $250.00 + –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ = $250.00 ‚Üí **$275.00** (‚ÇΩ27,500)

### –û—Ü–µ–Ω–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –†–§ (Shopfans Lite)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –†–æ—Å—Å–∏—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤:

**–§–æ—Ä–º—É–ª–∞**: `max($13.99, $14 √ó –≤–µ—Å) + (–≤–µ—Å ‚â§ 0.45–∫–≥ ? $3 : $5)`

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –í–µ—Å (–∫–≥) | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-----------|----------|-----------|
| –§—É—Ç–±–æ–ª–∫–∏ | 0.20 | $16.99 |
| –•—É–¥–∏/–°–≤–∏—Ç—à–æ—Ç—ã | 0.70 | $18.99 |
| –î–∂–∏–Ω—Å—ã | 0.70 | $18.99 |
| –ö—Ä–æ—Å—Å–æ–≤–∫–∏ | 1.40 | $23.60 |
| –ë–æ—Ç–∏–Ω–∫–∏ | 1.80 | $30.20 |
| –ß–µ–º–æ–¥–∞–Ω—ã | 3.00 | $47.00 |
| –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | 0.60 | $18.99 |

### –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç
- –ö—É—Ä—Å USD –∫ RUB –æ—Ç **–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏ (–¶–ë –†–§)** 
- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫—É—Ä—Å—ã: `https://www.cbr.ru/scripts/XML_daily.asp`
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ 5% –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É –∫—É—Ä—Å—É –¶–ë –†–§
- –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –∏ —Ä—É–±–ª—è—Ö
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API –¶–ë –†–§

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

- **eBay**: –ü–æ–ª–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- **Grailed**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å —Ä–∞—Å—á—ë—Ç–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
- **Grailed app.link**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Å—ã–ª–æ–∫

## Installation

```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables
export BOT_TOKEN="your_telegram_bot_token"
export PORT=8000  # Optional, defaults to 8000
```

## Usage

### Local Development
```bash
python price_bot.py
```
The bot will run in polling mode for local testing.

### Production Deployment (Railway)
The bot automatically detects Railway environment and switches to webhook mode.

```bash
# Railway deployment
railway up
```

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `BOT_TOKEN` | Yes | Telegram bot token from @BotFather |
| `PORT` | No | Server port (default: 8000) |
| `RAILWAY_PUBLIC_DOMAIN` | No | Railway domain for webhook mode |

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

- `/start` - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω–∞—Ö
- **–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä eBay/Grailed** - –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –∫–æ–º–∏—Å—Å–∏–µ–π –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ —Ä—É–±–ª–∏
- **–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å Grailed** - –ê–Ω–∞–ª–∏–∑ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞

## –¢–∏–ø—ã –æ—Ç–≤–µ—Ç–æ–≤

### –¢–æ–≤–∞—Ä —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–æ–π
```
–¶–µ–Ω–∞: $89.99 + $12.50 –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –°–®–ê + $16.99 –¥–æ—Å—Ç–∞–≤–∫–∞ –†–§ = $119.48
–° —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏—è $15: $134.48 (‚ÇΩ13,448.00)

üíé –ü—Ä–æ–¥–∞–≤–µ—Ü: Diamond (92/100)
–ü—Ä–æ–¥–∞–≤–µ—Ü —Ç–æ–ø-—É—Ä–æ–≤–Ω—è, –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
```

### –¢–æ–≤–∞—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤  
```
–£ –ø—Ä–æ–¥–∞–≤—Ü–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Ü–µ–Ω–∞ –≤—ã–∫—É–ø–∞. –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–ª–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º.

–£–∫–∞–∑–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞: $150 (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤)
```

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞
```
üíé –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–≤—Ü–∞ Grailed

–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å: Diamond (92/100)
–ü—Ä–æ–¥–∞–≤–µ—Ü —Ç–æ–ø-—É—Ä–æ–≤–Ω—è, –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

–î–µ—Ç–∞–ª–∏:
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 30/30 (–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è)
‚Ä¢ –†–µ–π—Ç–∏–Ω–≥: 35/35 (4.9/5.0)
‚Ä¢ –û—Ç–∑—ã–≤—ã: 25/25 (245 –æ—Ç–∑—ã–≤–æ–≤)
‚Ä¢ –ë–µ–π–¥–∂: 10/10 (‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü)
```

## Architecture

### Core Files
- **`price_bot.py`**: Main application logic with all scraping and analysis functions
- **`messages.py`**: Centralized localized messages in Russian for easy editing and maintenance

### Technical Stack
- **HTTP session**: Retry logic and proper user agents for reliable scraping
- **Concurrent processing**: `asyncio.gather()` for parallel URL processing
- **Robust parsing**: Multiple extraction strategies for evolving website structures:
  - BeautifulSoup for HTML parsing with multiple CSS selectors
  - JSON parsing with various field name patterns and fallback strategies
  - Comprehensive error handling and detailed logging
- **Financial precision**: Decimal arithmetic for accurate price calculations
- **Date handling**: Multiple datetime formats (ISO, epoch, HTML attributes)

### Data Extraction Strategy
The bot uses a multi-layered approach for reliable data extraction from dynamic websites:

1. **JSON Parsing**: Primary method using multiple regex patterns for various field names
2. **HTML Fallback**: Secondary method parsing visible HTML elements when JSON fails  
3. **Profile Fetching**: Tertiary method fetching seller data directly from profile pages
4. **Comprehensive Logging**: Detailed debug information for troubleshooting extraction issues

## Error Handling

- **Currency conversion**: CBR API failures trigger admin notifications via Telegram
- **Robust extraction**: Multiple CSS selectors and JSON patterns for price extraction
- **Request resilience**: Timeouts and retry mechanisms for network reliability
- **Comprehensive logging**: Detailed debug information for troubleshooting scraping issues
- **Fallback strategies**: Multiple extraction methods when primary parsing fails
- **Conservative approach**: Shows USD only if CBR API is unavailable (no fallback rates)

## Recent Updates

### Enhanced Seller Data Extraction (Latest)
- **Multi-pattern parsing**: Added comprehensive regex patterns for various JSON field formats
- **Robust date handling**: Support for ISO dates, epoch timestamps, and HTML datetime attributes  
- **Fallback strategies**: HTML parsing when JSON data is unavailable
- **Profile URL detection**: Updated patterns for new Grailed URL structure (`/username` format)
- **Detailed logging**: Enhanced debug information for troubleshooting extraction issues
- **Messages module**: Centralized all user-facing text in `messages.py` for easy localization

### Previous Features
- Grailed seller reliability evaluation system with 4-criteria scoring
- Tiered commission structure ($15 fixed vs 10% markup)
- Central Bank of Russia currency conversion with admin notifications
- Concurrent URL processing for multiple links
- Buy-now vs offer-only detection for Grailed listings

## Development

See `CLAUDE.md` for detailed development guidance and architecture information.